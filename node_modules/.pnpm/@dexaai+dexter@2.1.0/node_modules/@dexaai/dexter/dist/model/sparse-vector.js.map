{"version":3,"file":"sparse-vector.js","sourceRoot":"","sources":["../../src/model/sparse-vector.ts"],"names":[],"mappings":"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","sourcesContent":["import type { PartialDeep } from 'type-fest';\nimport pThrottle from 'p-throttle';\nimport pMap from 'p-map';\nimport { type Options as KYOptions } from 'ky';\nimport type { ModelArgs } from './model.js';\nimport { AbstractModel } from './model.js';\nimport type { Model } from './types.js';\nimport { createSpladeClient } from './clients/splade.js';\nimport { deepMerge, mergeEvents, type Prettify } from '../utils/helpers.js';\n\nexport type SparseVectorModelArgs<CustomCtx extends Model.Ctx> = Prettify<\n  Omit<\n    ModelArgs<\n      Model.SparseVector.Client,\n      Model.SparseVector.Config,\n      Model.SparseVector.Run,\n      Model.SparseVector.Response,\n      CustomCtx\n    >,\n    'client'\n  > & {\n    serviceUrl?: string;\n  }\n>;\n\nexport type PartialSparseVectorModelArgs<CustomCtx extends Model.Ctx> =\n  Prettify<\n    PartialDeep<Pick<SparseVectorModelArgs<Partial<CustomCtx>>, 'params'>> &\n      Partial<Omit<SparseVectorModelArgs<Partial<CustomCtx>>, 'params'>>\n  >;\n\nexport class SparseVectorModel<\n  CustomCtx extends Model.Ctx = Model.Ctx,\n> extends AbstractModel<\n  Model.SparseVector.Client,\n  Model.SparseVector.Config,\n  Model.SparseVector.Run,\n  Model.SparseVector.Response,\n  Model.SparseVector.ApiResponse,\n  CustomCtx\n> {\n  modelType = 'sparse-vector' as const;\n  modelProvider = 'custom' as const;\n  serviceUrl: string;\n\n  constructor(args: SparseVectorModelArgs<CustomCtx>) {\n    const { serviceUrl, ...rest } = args;\n    super({ client: createSpladeClient(), ...rest });\n    const safeProcess = globalThis.process || { env: {} };\n    const tempServiceUrl = serviceUrl || safeProcess.env['SPLADE_SERVICE_URL'];\n    if (!tempServiceUrl) {\n      throw new Error('Missing process.env.SPLADE_SERVICE_URL');\n    }\n    this.serviceUrl = tempServiceUrl;\n  }\n\n  protected async runModel(\n    {\n      requestOpts,\n      ...params\n    }: Model.SparseVector.Run & Model.SparseVector.Config,\n    context: CustomCtx\n  ): Promise<Model.SparseVector.Response> {\n    const start = Date.now();\n    const interval = params.throttleInterval ?? 1000 * 60; // 1 minute\n    const limit = params.throttleLimit ?? 600;\n    const concurrency = params.concurrency ?? 10;\n\n    // Create a throttled version of the function for a single request\n    const throttled = pThrottle({ limit, interval })(\n      async (params: { input: string; model: string }) =>\n        this.runSingle(params, context)\n    );\n\n    // Run the requests in parallel, respecting the maxConcurrentRequests value\n    const inputs = params.input.map((input) => ({\n      input,\n      model: params.model,\n    }));\n    const responses = await pMap(inputs, throttled, { concurrency });\n\n    return {\n      vectors: responses.map((r) => r.vector),\n      cached: false,\n      latency: Date.now() - start,\n    };\n  }\n\n  protected async runSingle(\n    params: {\n      input: string;\n      model: string;\n      requestOpts?: {\n        headers?: KYOptions['headers'];\n      };\n    },\n    context: CustomCtx\n  ): Promise<{\n    vector: Model.SparseVector.Vector;\n    tokens: {\n      prompt: number;\n      completion: number;\n      total: number;\n    };\n  }> {\n    const start = Date.now();\n    const vector: Model.SparseVector.Vector =\n      await this.client.createSparseVector(params, this.serviceUrl);\n    const latency = Date.now() - start;\n\n    // Don't need tokens for this model\n    const tokens = { prompt: 0, completion: 0, total: 0 } as const;\n    const { input, model } = params;\n    await Promise.allSettled(\n      this.events?.onApiResponse?.map((event) =>\n        Promise.resolve(\n          event({\n            timestamp: new Date().toISOString(),\n            modelType: this.modelType,\n            modelProvider: this.modelProvider,\n            params: { input: [input], model },\n            response: vector,\n            latency,\n            context,\n          })\n        )\n      ) ?? []\n    );\n\n    return { vector, tokens };\n  }\n\n  /** Clone the model and merge/override the given properties. */\n  extend(args?: PartialSparseVectorModelArgs<CustomCtx>): this {\n    return new SparseVectorModel({\n      cacheKey: this.cacheKey,\n      cache: this.cache,\n      debug: this.debug,\n      serviceUrl: this.serviceUrl,\n      ...args,\n      context: deepMerge(this.context, args?.context),\n      params: deepMerge(this.params, args?.params),\n      events: mergeEvents(this.events, args?.events),\n    }) as unknown as this;\n  }\n}\n"]}