{"version":3,"file":"chat.test.js","sourceRoot":"","sources":["../../src/model/chat.test.ts"],"names":[],"mappings":"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","sourcesContent":["import { describe, expect, it, vi } from 'vitest';\nimport type { Model } from './types.js';\nimport { ChatModel } from './chat.js';\n\nconst FAKE_RESPONSE: Model.Chat.Response = {\n  message: {\n    content: 'Hi from fake AI',\n    role: 'assistant',\n  },\n  cached: false,\n  latency: 0,\n  cost: 0,\n  created: 0,\n  id: 'fake-id',\n  model: 'gpt-fake',\n  object: 'chat.completion',\n  usage: {\n    completion_tokens: 1,\n    prompt_tokens: 1,\n    total_tokens: 2,\n  },\n  choices: [\n    {\n      finish_reason: 'stop',\n      index: 0,\n      message: {\n        content: 'Hi from fake AI',\n        role: 'assistant',\n      },\n      logprobs: null,\n    },\n  ],\n};\n\ndescribe('ChatModel', () => {\n  let Client: Model.Chat.Client;\n\n  beforeEach(() => {\n    vi.setSystemTime(new Date());\n    Client = vi.fn() as unknown as Model.Chat.Client;\n    Client.createChatCompletion = vi\n      .fn()\n      .mockImplementation(() => Promise.resolve(FAKE_RESPONSE));\n  });\n\n  afterEach(() => {\n    vi.clearAllMocks();\n    vi.clearAllTimers();\n  });\n\n  it('runs the model', async () => {\n    const chatModel = new ChatModel({ client: Client });\n    const response = await chatModel.run({\n      messages: [{ role: 'user', content: 'content' }],\n    });\n    expect(response).toEqual(FAKE_RESPONSE);\n  });\n\n  it('triggers events', async () => {\n    const startEvent = vi.fn();\n    const apiResponseEvent = vi.fn();\n    const completeEvent = vi.fn();\n    const chatModel = new ChatModel({\n      client: Client,\n      params: { model: 'gpt-fake' },\n      events: {\n        onStart: [startEvent],\n        onApiResponse: [apiResponseEvent],\n        onComplete: [completeEvent],\n      },\n      context: { userId: '123' },\n    });\n    await chatModel.run({\n      messages: [{ role: 'user', content: 'content' }],\n    });\n    expect(startEvent).toHaveBeenCalledOnce();\n    expect(apiResponseEvent).toHaveBeenCalledOnce();\n    expect(completeEvent).toHaveBeenCalledOnce();\n    expect(apiResponseEvent).toHaveBeenCalledWith({\n      timestamp: new Date().toISOString(),\n      modelType: 'chat',\n      modelProvider: 'openai',\n      params: {\n        model: 'gpt-fake',\n        messages: [{ role: 'user', content: 'content' }],\n      },\n      response: FAKE_RESPONSE,\n      latency: 0,\n      context: { userId: '123' },\n    });\n  });\n\n  it('implements extend', async () => {\n    type ChatContext = { userId: string; cloned?: boolean };\n    const chatModel = new ChatModel<ChatContext>({\n      client: Client,\n      context: { userId: '123' },\n      params: { model: 'gpt-fake' },\n      events: { onApiResponse: [() => {}] },\n    });\n    const clonedModel = chatModel.extend({\n      context: { cloned: true },\n      params: { model: 'gpt-fake-cloned' },\n      events: { onApiResponse: [() => {}] },\n    });\n    expect(clonedModel.context).toEqual({\n      userId: '123',\n      cloned: true,\n    });\n    expect(clonedModel.params).toEqual({\n      model: 'gpt-fake-cloned',\n    });\n    expect(clonedModel.events.onApiResponse?.length).toBe(2);\n  });\n\n  it('can cache responses', async () => {\n    const apiResponseEvent = vi.fn();\n    const completeEvent = vi.fn();\n    const chatModel = new ChatModel({\n      cache: new Map(),\n      client: Client,\n      params: { model: 'gpt-fake' },\n      events: {\n        onApiResponse: [apiResponseEvent],\n        onComplete: [completeEvent],\n      },\n      context: { userId: '123' },\n    });\n    await chatModel.run({\n      messages: [{ role: 'user', content: 'content' }],\n    });\n    expect(apiResponseEvent).toHaveBeenCalledOnce();\n    expect(completeEvent).toHaveBeenCalledOnce();\n    expect(Client.createChatCompletion).toHaveBeenCalledOnce();\n    // Make the same request that should be cached\n    await chatModel.run({\n      messages: [{ role: 'user', content: 'content' }],\n    });\n    // onApiResponse event isn't triggered for cached responses\n    expect(apiResponseEvent).toHaveBeenCalledOnce();\n    // onComplete is called for cached responses\n    expect(completeEvent).toHaveBeenCalledTimes(2);\n    expect(Client.createChatCompletion).toHaveBeenCalledOnce();\n  });\n\n  it('can be extended', async () => {\n    // Create a mocked cache (Map) to ensure that the cache is passed down\n    const cache = new Map();\n    const getSpy = vi.spyOn(cache, 'get');\n    const onComplete1 = vi.fn();\n    const onComplete2 = vi.fn();\n    const onError = vi.fn();\n    const onApiResponse = vi.fn();\n\n    // Create a ChatModel instance and make a request\n    const chatModel = new ChatModel({\n      cache,\n      client: Client,\n      params: { model: 'gpt-fake' },\n      context: { level: 1, userId: '123' },\n      events: {\n        onApiResponse: [onApiResponse],\n        onComplete: [onComplete1, onComplete2],\n        onError: [onError],\n      },\n    });\n    await chatModel.run({ messages: [{ role: 'user', content: 'content2' }] });\n\n    // Ensure the base model works as expected\n    expect(getSpy).toHaveBeenCalledOnce();\n    expect(onApiResponse).toHaveBeenCalledOnce();\n    expect(onComplete1).toHaveBeenCalledOnce();\n    expect(onComplete1).toHaveBeenCalledOnce();\n    expect(onError).not.toHaveBeenCalled();\n    expect(chatModel.params.model).toBe('gpt-fake');\n    expect(chatModel.context).toEqual({ level: 1, userId: '123' });\n\n    const newOnComplete = vi.fn();\n\n    // Extend the model and make another request\n    const secondChatModel = chatModel.extend({\n      params: { model: 'gpt-fake-extended' },\n      context: { level: 2 },\n      events: { onComplete: [newOnComplete] },\n    });\n    await secondChatModel.run({\n      messages: [{ role: 'user', content: 'content' }],\n    });\n\n    // Ensure the old model is unchanged\n    expect(chatModel.params.model).toBe('gpt-fake');\n    expect(chatModel.context).toEqual({ level: 1, userId: '123' });\n\n    // Ensure the new model works as expected\n    expect(onApiResponse).toHaveBeenCalledTimes(2);\n    expect(onComplete1).toHaveBeenCalledTimes(2); // these are kept when extending\n    expect(onComplete2).toHaveBeenCalledTimes(2); // these are kept when extending\n    expect(newOnComplete).toHaveBeenCalledOnce();\n    expect(onError).not.toHaveBeenCalled();\n    expect(getSpy).toHaveBeenCalledTimes(2);\n    expect(secondChatModel.params.model).toBe('gpt-fake-extended');\n    expect(secondChatModel.context).toEqual({ level: 2, userId: '123' });\n\n    const cache2 = new Map();\n    const getSpy2 = vi.spyOn(cache2, 'get');\n\n    // Extend again to clear properties\n    const thirdChatModel = secondChatModel.extend({\n      cache: cache2,\n      params: { model: 'gpt-fake-extended-2' },\n      context: {},\n      events: {},\n    });\n    await thirdChatModel.run({\n      messages: [{ role: 'user', content: 'content3' }],\n    });\n\n    expect(thirdChatModel.params).toEqual({ model: 'gpt-fake-extended-2' });\n    expect(thirdChatModel.context).toEqual({});\n    expect(thirdChatModel.events).toEqual({});\n\n    expect(getSpy2).toHaveBeenCalledOnce();\n    expect(getSpy).toHaveBeenCalledTimes(2);\n    expect(newOnComplete).toHaveBeenCalledOnce();\n    expect(onError).not.toHaveBeenCalled();\n    expect(getSpy).toHaveBeenCalledTimes(2);\n    expect(secondChatModel.params.model).toBe('gpt-fake-extended');\n  });\n\n  it(`mutating event data doesn't impact the models context and params`, async () => {\n    const onComplete = vi.fn().mockImplementation((e: any) => {\n      e.userId = 'mutated';\n      e.params.model = 'mutated';\n    });\n\n    const chatModel = new ChatModel({\n      client: Client,\n      params: { model: 'gpt-fake' },\n      events: { onComplete: [onComplete] },\n      context: { userId: '123' },\n    });\n    await chatModel.run({ messages: [{ role: 'user', content: 'content2' }] });\n\n    expect(onComplete).toHaveBeenCalledOnce();\n    expect(chatModel.context.userId).toBe('123');\n    expect(chatModel.params.model).toBe('gpt-fake');\n  });\n});\n"]}