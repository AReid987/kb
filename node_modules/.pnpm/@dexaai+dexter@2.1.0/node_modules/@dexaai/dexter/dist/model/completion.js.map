{"version":3,"file":"completion.js","sourceRoot":"","sources":["../../src/model/completion.ts"],"names":[],"mappings":"AAIA,OAAO,EAAE,aAAa,EAAE,MAAM,2BAA2B,CAAC;AAC1D,OAAO,EAAE,kBAAkB,EAAE,MAAM,qBAAqB,CAAC;AACzD,OAAO,EAAE,aAAa,EAAE,MAAM,YAAY,CAAC;AAC3C,OAAO,EAAE,SAAS,EAAE,WAAW,EAAiB,MAAM,aAAa,CAAC;AAkBpE,MAAM,OAAO,eAEX,SAAQ,aAOT;IACC,SAAS,GAAG,YAAqB,CAAC;IAClC,aAAa,GAAG,QAAiB,CAAC;IAElC,YAAY,IAAqC;QAC/C,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,GAAG,IAAI,EAAE,GAAG,IAAI,IAAI,EAAE,CAAC;QAC7C,2CAA2C;QAC3C,MAAM,GAAG,MAAM,IAAI,kBAAkB,EAAE,CAAC;QACxC,8CAA8C;QAC9C,MAAM,GAAG,MAAM,IAAI,EAAE,KAAK,EAAE,wBAAwB,EAAE,CAAC;QACvD,KAAK,CAAC,EAAE,MAAM,EAAE,MAAM,EAAE,GAAG,IAAI,EAAE,CAAC,CAAC;IACrC,CAAC;IAES,KAAK,CAAC,QAAQ,CACtB,EAAE,WAAW,EAAE,GAAG,MAAM,EAAkD,EAC1E,OAAkB;QAElB,MAAM,KAAK,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAEzB,8BAA8B;QAC9B,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC,MAAM,EAAE,WAAW,CAAC,CAAC;QAE1E,MAAM,OAAO,CAAC,UAAU,CACtB,IAAI,CAAC,MAAM,EAAE,aAAa,EAAE,GAAG,CAAC,CAAC,KAAK,EAAE,EAAE,CACxC,OAAO,CAAC,OAAO,CACb,KAAK,CAAC;YACJ,SAAS,EAAE,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE;YACnC,SAAS,EAAE,IAAI,CAAC,SAAS;YACzB,aAAa,EAAE,IAAI,CAAC,aAAa;YACjC,MAAM;YACN,QAAQ;YACR,OAAO,EAAE,IAAI,CAAC,GAAG,EAAE,GAAG,KAAK;YAC3B,OAAO;SACR,CAAC,CACH,CACF,IAAI,EAAE,CACR,CAAC;QAEF,MAAM,aAAa,GAA8B;YAC/C,GAAG,QAAQ;YACX,UAAU,EAAE,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI;YACpC,MAAM,EAAE,KAAK;YACb,IAAI,EAAE,aAAa,CAAC,EAAE,KAAK,EAAE,MAAM,CAAC,KAAK,EAAE,MAAM,EAAE,QAAQ,CAAC,KAAK,EAAE,CAAC;SACrE,CAAC;QAEF,OAAO,aAAa,CAAC;IACvB,CAAC;IAED,+DAA+D;IAC/D,MAAM,CAAC,IAA4C;QACjD,OAAO,IAAI,eAAe,CAAC;YACzB,QAAQ,EAAE,IAAI,CAAC,QAAQ;YACvB,KAAK,EAAE,IAAI,CAAC,KAAK;YACjB,MAAM,EAAE,IAAI,CAAC,MAAM;YACnB,KAAK,EAAE,IAAI,CAAC,KAAK;YACjB,GAAG,IAAI;YACP,OAAO,EAAE,SAAS,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,EAAE,OAAO,CAAC;YAC/C,MAAM,EAAE,SAAS,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,CAAC;YAC5C,MAAM,EAAE,WAAW,CAAC,IAAI,CAAC,MAAM,EAAE,IAAI,EAAE,MAAM,CAAC;SAC/C,CAAoB,CAAC;IACxB,CAAC;CACF","sourcesContent":["import type { PartialDeep } from 'type-fest';\nimport type { SetOptional } from 'type-fest';\nimport type { ModelArgs } from './model.js';\nimport type { Model } from './types.js';\nimport { calculateCost } from './utils/calculate-cost.js';\nimport { createOpenAIClient } from './clients/openai.js';\nimport { AbstractModel } from './model.js';\nimport { deepMerge, mergeEvents, type Prettify } from '../index.js';\n\nexport type CompletionModelArgs<CustomCtx extends Model.Ctx> = SetOptional<\n  ModelArgs<\n    Model.Completion.Client,\n    Model.Completion.Config,\n    Model.Completion.Run,\n    Model.Completion.Response,\n    CustomCtx\n  >,\n  'client' | 'params'\n>;\n\nexport type PartialCompletionModelArgs<CustomCtx extends Model.Ctx> = Prettify<\n  PartialDeep<Pick<CompletionModelArgs<Partial<CustomCtx>>, 'params'>> &\n    Partial<Omit<CompletionModelArgs<Partial<CustomCtx>>, 'params'>>\n>;\n\nexport class CompletionModel<\n  CustomCtx extends Model.Ctx = Model.Ctx,\n> extends AbstractModel<\n  Model.Completion.Client,\n  Model.Completion.Config,\n  Model.Completion.Run,\n  Model.Completion.Response,\n  Model.Completion.ApiResponse,\n  CustomCtx\n> {\n  modelType = 'completion' as const;\n  modelProvider = 'openai' as const;\n\n  constructor(args?: CompletionModelArgs<CustomCtx>) {\n    let { client, params, ...rest } = args ?? {};\n    // Add a default client if none is provided\n    client = client ?? createOpenAIClient();\n    // Set default model if no params are provided\n    params = params ?? { model: 'gpt-3.5-turbo-instruct' };\n    super({ client, params, ...rest });\n  }\n\n  protected async runModel(\n    { requestOpts, ...params }: Model.Completion.Run & Model.Completion.Config,\n    context: CustomCtx\n  ): Promise<Model.Completion.Response> {\n    const start = Date.now();\n\n    // Make the OpenAI API request\n    const response = await this.client.createCompletions(params, requestOpts);\n\n    await Promise.allSettled(\n      this.events?.onApiResponse?.map((event) =>\n        Promise.resolve(\n          event({\n            timestamp: new Date().toISOString(),\n            modelType: this.modelType,\n            modelProvider: this.modelProvider,\n            params,\n            response,\n            latency: Date.now() - start,\n            context,\n          })\n        )\n      ) ?? []\n    );\n\n    const modelResponse: Model.Completion.Response = {\n      ...response,\n      completion: response.choices[0].text,\n      cached: false,\n      cost: calculateCost({ model: params.model, tokens: response.usage }),\n    };\n\n    return modelResponse;\n  }\n\n  /** Clone the model and merge/override the given properties. */\n  extend(args?: PartialCompletionModelArgs<CustomCtx>): this {\n    return new CompletionModel({\n      cacheKey: this.cacheKey,\n      cache: this.cache,\n      client: this.client,\n      debug: this.debug,\n      ...args,\n      context: deepMerge(this.context, args?.context),\n      params: deepMerge(this.params, args?.params),\n      events: mergeEvents(this.events, args?.events),\n    }) as unknown as this;\n  }\n}\n"]}